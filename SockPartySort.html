<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squad Builder</title>
    <script src="./src/tailwind.3417.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; 
            color: #e2e8f0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.light-mode {
            background-color: #f0f4f8;
            color: #6b7280;
        }
        .kpi-card {
            background-color: #F29F05;
            color: white;
        }
        
        .toggle-switch {
            position: absolute;
            top: 5px;
            left: 20px;
            z-index: 10;
        }
        .toggle-switch input[type="checkbox"] {
            height: 0;
            width: 0;
            visibility: hidden;
        }
        .toggle-switch label {
            cursor: pointer;
            text-indent: -9999px;
            width: 60px;
            height: 30px;
            background: #4a5568;
            display: block;
            border-radius: 100px;
            position: relative;
        }
        .toggle-switch label:after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 90px;
            transition: 0.3s;
        }
        .toggle-switch input:checked + label {
            background: #00A6A6;
        }
        .toggle-switch input:checked + label:after {
            left: calc(100% - 3px);
            transform: translateX(-100%);
        }

        /* Role Colors */
        .role-aoe-dps { background-color: #8FBC8F; }
        .role-healer { background-color: #ADD8E6; color: #1a202c; } 
        .role-boon-support { background-color: #FFB6C1; color: #1a202c; } 
        .role-dps { background-color: #F08080; }
        .role-main-stabs { background-color: #FFFFE0; color: #1a202c; } 
        .role-commander { background-color: #F29F05; }
        .role-empty { background-color: #4a5568; }

        [contenteditable]:focus {
            outline: 2px solid #F29F05;
            background-color: #3b4252;
        }
        td[draggable="true"] {
            cursor: grab;
        }
        .code-output {
            background-color: #3b4252;
            color: #f0f4f8;
            padding: 1rem;
            border-radius: 0.5rem;
            word-break: break-all;
            margin-top: 1rem;
        }
        
        /* Collapsible Styling */
        summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        summary::-webkit-details-marker {
            display: none;
        }
        summary::after {
            content: '▶';
            font-size: 0.8rem;
            transition: transform 0.2s;
        }
        details[open] summary::after {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="p-6 min-h-screen">

    <div class="toggle-switch">
        <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
        <label for="theme-toggle">Toggle</label>
    </div>

    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-bold mb-8 text-center">Squad Builder</h1>

        <div id="input-section" class="bg-gray-700/50 p-6 rounded-lg shadow-xl">
            <h2 class="text-2xl font-semibold mb-4">Paste Sign-up List or Layout Code</h2>
            
            <div class="mb-4">
                <label for="participant-count" class="block text-sm font-medium mb-1">Target Participant Count:</label>
                <select id="participant-count" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-600 focus:ring-yellow-500 rounded-md bg-gray-800 text-white">
                    <option value="50" selected>50 Participants (11 Groups)</option>
                    <option value="40">40 Participants (9 Groups)</option>
                    <option value="30">30 Participants (7 Groups)</option>
                </select>
            </div>
            
            <div class="mb-4">
                <textarea id="signup-list" rows="10" class="block w-full sm:text-sm border-gray-600 rounded-md p-3 bg-gray-800 text-white" placeholder="Paste Discord signup list here..."></textarea>
            </div>

            <button onclick="processList()" class="w-full kpi-card hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded transition">
                Generate Squad Grid
            </button>
        </div>

        <div id="grid-section" class="hidden mt-8">
            <h2 class="text-2xl font-semibold mb-4 text-center">Proposed Squad Composition</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <div class="flex-grow">
                    <label class="block text-sm font-medium mb-1">Adjust Visible Groups:</label>
                    <select id="grid-participant-count" onchange="updateGridSize()" class="block w-full p-2 border-gray-600 rounded-md bg-gray-800 text-white">
                        <option value="50">50 Participants (11 Groups)</option>
                        <option value="40">40 Participants (9 Groups)</option>
                        <option value="30">30 Participants (7 Groups)</option>
                    </select>
                </div>
                <button onclick="createLayoutCode()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded self-end">
                    Create Layout Code
                </button>
            </div>

            <div id="code-output-container" class="hidden mb-4">
                <div id="layout-code-display" class="code-output select-all text-xs"></div>
            </div>

            <div id="squad-grid" class="overflow-x-auto"></div>
            
            <button onclick="resetApp()" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded transition">
                Reset / Enter New List
            </button>

            <details id="mapping-adjustment-ui" class="mt-12 bg-gray-800/50 p-6 rounded-lg shadow-xl border border-gray-600 transition-all duration-300">
                <summary class="text-xl font-semibold select-none">
                    Role Mapping Adjustments
                </summary>
                
                <div class="mt-4">
                    <p class="text-sm text-gray-400 mb-4">The headers below were detected in your list. Change their mappings here to rebuild the squad.</p>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full mb-6">
                            <thead class="bg-gray-900">
                                <tr class="text-left">
                                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider">Detected Header</th>
                                    <th class="px-4 py-3 text-xs font-medium uppercase tracking-wider">Assigned Column</th>
                                </tr>
                            </thead>
                            <tbody id="mapping-tbody" class="divide-y divide-gray-700">
                                </tbody>
                        </table>
                    </div>
                    
                    <button onclick="applyMappingsAndGenerate()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded transition">
                        Update Squad Composition
                    </button>
                </div>
            </details>
        </div>
    </div>

    <script>
        // --- Globals ---
        window.currentRoster = null;
        window.customRoleMappings = {};
        let draggedCell = null;
        const CODE_PREFIX = "SQUAD_LAYOUT_V1:";
        const EMPTY_PLACEHOLDER = '... EMPTY ...';
        const COMPRESSION_CODE = '~';

        const ROLES = {
            'AOE DPS': 'role-aoe-dps',
            'Healer': 'role-healer',
            'Boon Support': 'role-boon-support',
            'DPS': 'role-dps',
            'Main Stabs': 'role-main-stabs',
            'Commander': 'role-commander',
            'Support Spellbreaker': 'role-boon-support'
        };

        const GROUP_CONFIGS = { '30': 7, '40': 9, '50': 11 };
        const SPELLBREAKER_GROUPS = [3, 5];
        const ALL_ROLE_CLASSES = Object.values(ROLES).concat(['role-empty']);

        // --- Core Functions ---

        function processList() {
            const signupText = document.getElementById('signup-list').value.trim();
            if (!signupText) return alert('Please paste a list or layout code.');

            if (signupText.startsWith(CODE_PREFIX)) {
                handleLayoutCodeLoad(signupText);
                return;
            }

            const roster = parseSignupList(signupText);
            window.currentRoster = roster;

            generateDefaultMappings(roster);
            populateMappingUI(roster);

            const selectedCount = document.getElementById('participant-count').value;
            document.getElementById('grid-participant-count').value = selectedCount;
            buildSquadGrid(GROUP_CONFIGS[selectedCount], roster, null);

            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('grid-section').classList.remove('hidden');
        }

        function generateDefaultMappings(roster) {
            window.customRoleMappings = {};
            Object.keys(roster).forEach(role => {
                let defaultVal = "DPS"; 
                const lowRole = role.toLowerCase();
                
                // Rules prioritised to catch specific "Boon Strips" before general "Boon"
                if (role.startsWith("Participants")) defaultVal = "IGNORE";
                else if (lowRole.includes('commander')) defaultVal = "Commander";
                else if (lowRole.includes('healer')) defaultVal = "Healer";
                else if (lowRole.includes('strip') || lowRole.includes('pull') || lowRole.includes('aoe')) defaultVal = "AOE DPS";
                else if (lowRole.includes('boon') || lowRole.includes('harb') || lowRole.includes('secondary')) defaultVal = "Boon Support";
                else if (lowRole.includes('spellbreaker')) defaultVal = "Support Spellbreaker";
                else if (lowRole.includes('stab')) defaultVal = "Main Stabs";

                window.customRoleMappings[role] = defaultVal;
            });
        }

        function populateMappingUI(roster) {
            const mappingTbody = document.getElementById('mapping-tbody');
            mappingTbody.innerHTML = '';
            
            Object.keys(roster).forEach(role => {
                const currentAssigned = window.customRoleMappings[role];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-200">${role}</td>
                    <td class="px-4 py-3">
                        <select data-signup-role="${role}" class="bg-gray-700 text-white rounded p-2 border border-gray-600 w-full focus:ring-yellow-500">
                            <option value="AOE DPS" ${currentAssigned === "AOE DPS" ? 'selected' : ''}>AOE DPS</option>
                            <option value="Healer" ${currentAssigned === "Healer" ? 'selected' : ''}>Healer</option>
                            <option value="Boon Support" ${currentAssigned === "Boon Support" ? 'selected' : ''}>Boon Support</option>
                            <option value="DPS" ${currentAssigned === "DPS" ? 'selected' : ''}>DPS</option>
                            <option value="Main Stabs" ${currentAssigned === "Main Stabs" ? 'selected' : ''}>Main Stabs</option>
                            <option value="Commander" ${currentAssigned === "Commander" ? 'selected' : ''}>Commander</option>
                            <option value="Support Spellbreaker" ${currentAssigned === "Support Spellbreaker" ? 'selected' : ''}>Support Spellbreaker</option>
                            <option value="IGNORE" ${currentAssigned === "IGNORE" ? 'selected' : ''}>❌ Ignore this Role</option>
                        </select>
                    </td>
                `;
                mappingTbody.appendChild(row);
            });
        }

        function applyMappingsAndGenerate() {
            const selects = document.querySelectorAll('#mapping-tbody select');
            window.customRoleMappings = {};
            selects.forEach(sel => {
                window.customRoleMappings[sel.getAttribute('data-signup-role')] = sel.value;
            });

            const selectedCount = document.getElementById('grid-participant-count').value;
            buildSquadGrid(GROUP_CONFIGS[selectedCount], window.currentRoster, null);
            
            document.getElementById('squad-grid').scrollIntoView({ behavior: 'smooth' });
        }

        function buildSquadGrid(totalGroups, roster = null, layoutArray = null) {
            const gridContainer = document.getElementById('squad-grid');
            gridContainer.innerHTML = '';

            let html = `<table class="min-w-full divide-y divide-gray-600 rounded-lg overflow-hidden shadow-2xl">
                <thead class="bg-gray-800/80">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase">Group</th>
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase ${ROLES['AOE DPS']}">AOE DPS</th>
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase ${ROLES['Healer']}">Healer</th>
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase ${ROLES['Boon Support']}">Boon Support</th>
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase ${ROLES['DPS']}">DPS</th>
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase ${ROLES['Main Stabs']}">Main Stabs</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">`;

            let commQ = [], healQ = [], boonQ = [], sbQ = [], dpsQ = [], aoeQ = [], stabQ = [];
            const getNext = (q) => q.shift() || EMPTY_PLACEHOLDER;

            if (!layoutArray && roster) {
                Object.keys(roster).forEach(signupRole => {
                    const target = window.customRoleMappings[signupRole];
                    const players = [...roster[signupRole]];
                    if (target === "Commander") commQ.push(...players);
                    else if (target === "Healer") healQ.push(...players);
                    else if (target === "Boon Support") boonQ.push(...players);
                    else if (target === "Support Spellbreaker") sbQ.push(...players);
                    else if (target === "DPS") dpsQ.push(...players);
                    else if (target === "AOE DPS") aoeQ.push(...players);
                    else if (target === "Main Stabs") stabQ.push(...players);
                });
            }

            let pIdx = 0;
            const getLayoutP = () => layoutArray[pIdx++];

            for (let i = 1; i <= totalGroups; i++) {
                html += `<tr class="bg-gray-700/50 hover:bg-gray-600/50">`;
                html += `<td class="px-3 py-2 font-medium">Group ${i}</td>`;
                
                let slots = [];
                if (i === 1) { // Lobby
                    for (let j = 0; j < 5; j++) slots.push({ p: layoutArray ? getLayoutP() : 'Lobby', c: 'role-empty', name: 'Lobby' });
                } else if (i === 2) { // Commander Group
                    slots.push({ p: layoutArray ? getLayoutP() : getNext(commQ), c: ROLES['Commander'], name: 'Commander' });
                    slots.push({ p: layoutArray ? getLayoutP() : getNext(healQ), c: ROLES['Healer'], name: 'Healer' });
                    slots.push({ p: layoutArray ? getLayoutP() : getNext(boonQ), c: ROLES['Boon Support'], name: 'Boon Support' });
                    slots.push({ p: layoutArray ? getLayoutP() : getNext(dpsQ), c: ROLES['DPS'], name: 'DPS' });
                    slots.push({ p: layoutArray ? getLayoutP() : getNext(stabQ), c: ROLES['Main Stabs'], name: 'Main Stabs' });
                } else { // Regular Groups
                    slots.push({ p: layoutArray ? getLayoutP() : getNext(aoeQ), c: ROLES['AOE DPS'], name: 'AOE DPS' });
                    slots.push({ p: layoutArray ? getLayoutP() : getNext(healQ), c: ROLES['Healer'], name: 'Healer' });
                    
                    let p, c = ROLES['Boon Support'];
                    if (!layoutArray && SPELLBREAKER_GROUPS.includes(i) && sbQ.length > 0) p = getNext(sbQ);
                    else p = layoutArray ? getLayoutP() : getNext(boonQ);
                    slots.push({ p, c, name: 'Boon Support / SB' });

                    slots.push({ p: layoutArray ? getLayoutP() : getNext(dpsQ), c: ROLES['DPS'], name: 'DPS' });
                    slots.push({ p: layoutArray ? getLayoutP() : getNext(stabQ), c: ROLES['Main Stabs'], name: 'Main Stabs' });
                }

                slots.forEach(slot => {
                    const isFilled = slot.p !== EMPTY_PLACEHOLDER && slot.p !== 'Lobby';
                    const finalClass = isFilled ? slot.c : 'role-empty opacity-50 text-center';
                    html += `<td class="px-3 py-2 font-semibold ${finalClass}" 
                                 draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)"
                                 data-role-class="${slot.c}" data-placeholder="${slot.p === 'Lobby' ? 'Lobby' : EMPTY_PLACEHOLDER}"
                                 ${!isFilled ? 'contenteditable="true" onblur="handleCellEdit(this)"' : ''}>${slot.p}</td>`;
                });
                html += `</tr>`;
            }
            gridContainer.innerHTML = html + `</tbody></table>`;
        }

        function handleLayoutCodeLoad(signupText) {
             try {
                const encoded = signupText.substring(CODE_PREFIX.length);
                const decodedData = atob(encoded);
                const parts = decodedData.split('|');
                const savedSize = parts[0];
                const layoutArray = parts.slice(1).map(item => item === COMPRESSION_CODE ? EMPTY_PLACEHOLDER : item);
                
                document.getElementById('grid-participant-count').value = savedSize;
                buildSquadGrid(GROUP_CONFIGS[savedSize], null, layoutArray);
                
                window.currentRoster = { isLayout: true, size: savedSize, layout: layoutArray };
                document.getElementById('input-section').classList.add('hidden');
                document.getElementById('grid-section').classList.remove('hidden');
                document.getElementById('mapping-adjustment-ui').classList.add('hidden');
            } catch (e) { alert("Invalid layout code."); }
        }

        function parseSignupList(text) {
            let cleaned = text.replace(/:\w+:\s*/g, ' ').replace(/[\u200B-\u200D\uFEFF]/g, '').trim();
            const lines = cleaned.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            const roster = {};
            let currentRole = null;
            const roleRegex = /^\s*([A-Za-z\s\/&]+)\s*\(\d+\/\d+\):?\s*$/; 
            const accRegex = /\(([^)]+\.\d{4})\)/g;

            for (const line of lines) {
                const roleMatch = line.match(roleRegex);
                if (roleMatch) { currentRole = roleMatch[1].trim(); roster[currentRole] = []; continue; }
                if (currentRole && line.startsWith('└')) {
                    const m = [...line.matchAll(accRegex)];
                    if (m.length > 0) roster[currentRole].push(m[m.length-1][1]);
                }
            }
            return roster;
        }

        function handleCellEdit(cell) {
            const roleC = cell.getAttribute('data-role-class');
            const placeholder = cell.getAttribute('data-placeholder');
            const val = cell.textContent.trim();
            cell.classList.remove(...ALL_ROLE_CLASSES, 'opacity-50', 'text-center');
            if (val === '' || val === placeholder) {
                cell.classList.add('role-empty', 'opacity-50', 'text-center');
                cell.textContent = placeholder;
                cell.setAttribute('contenteditable', 'true');
            } else {
                cell.classList.add(roleC);
                cell.removeAttribute('contenteditable');
            }
        }

        function drag(e) { draggedCell = e.target; e.dataTransfer.setData("text", ""); }
        function allowDrop(e) { e.preventDefault(); }
        function drop(e) {
            e.preventDefault();
            const target = e.target.closest('td');
            if (!draggedCell || !target || draggedCell === target || target.parentElement.rowIndex === 1) return;
            const sHTML = draggedCell.innerHTML;
            draggedCell.innerHTML = target.innerHTML;
            target.innerHTML = sHTML;
            handleCellEdit(draggedCell);
            handleCellEdit(target);
        }

        function createLayoutCode() {
            const size = document.getElementById('grid-participant-count').value;
            const cells = document.querySelectorAll('#squad-grid td[data-placeholder]');
            const data = [size, ...Array.from(cells).map(c => c.innerText.trim() === EMPTY_PLACEHOLDER ? COMPRESSION_CODE : c.innerText.trim())];
            const encoded = CODE_PREFIX + btoa(data.join('|'));
            document.getElementById('layout-code-display').textContent = encoded;
            document.getElementById('code-output-container').classList.remove('hidden');
            navigator.clipboard.writeText(encoded);
        }

        function updateGridSize() {
            if (!window.currentRoster || window.currentRoster.isLayout) return;
            const count = document.getElementById('grid-participant-count').value;
            buildSquadGrid(GROUP_CONFIGS[count], window.currentRoster, null);
        }

        function resetApp() { location.reload(); }
        function toggleTheme() { document.body.classList.toggle('light-mode'); }
    </script>
</body>
</html>