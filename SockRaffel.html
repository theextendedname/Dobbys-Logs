<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raffle Winner Picker</title>
    <style>
        /* Styles copied from stylesheet.txt */
        body {
            font-family: 'Inter', sans-serif; /* cite: 1 */
            background-color: #1a202c; /* Dark mode background */ /* cite: 2 */
            color: #e2e8f0; /* Light text for dark background */ /* cite: 3 */
            transition: background-color 0.3s ease, color 0.3s ease; /* cite: 3 */
        }
        body.light-mode {
            background-color: #f0f4f8; /* Light mode background */ /* cite: 4, 5 */
            color: #6b7280; /* Dark text for light background */ /* cite: 6 */
        }
        .kpi-card {
            background-color: #F29F05; /* Original KPI card color */ /* cite: 7 */
            color: white; /* cite: 8 */
        }
        .kpi-number {
            font-weight: 900; /* cite: 9 */
            font-size: 4rem; /* cite: 9 */
            line-height: 1; /* cite: 9 */
        }
        /* Custom styles for the slot machine and button */
        .slot-machine {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 50px;
        }
        .slot {
            background-color: #4a5568; 
            border: 4px solid #F29F05; /* cite: 7 */
            border-radius: 8px;
            margin: 0 10px;
            width: 300px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }
        .slot-inner {
            width: 100%;
            text-align: center;
            position: absolute;
            transition: transform 0.1s ease-out;
        }
        .draw-button {
            display: block;
            width: 300px;
            margin: 40px auto 20px auto;
            padding: 15px 30px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            background-color: #00A6A6; /* cite: 27 */
            color: white;
            border: none;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }
        .draw-button:hover {
            background-color: #007a7a;
        }
        .draw-button:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
        }
        .winner-display {
            text-align: center;
            margin-top: 30px;
            font-size: 1.5rem;
            color: #F29F05; /* cite: 7 */
            min-height: 40px;
        }
    </style>
    
    <script src="src/index.js"></script>
</head>
<body>

    <h1 style="text-align: center; margin-top: 50px;">üçÄ Raffle Winner Picker üçÄ</h1>

    <div class="winner-display" id="winner-message">Loading data...</div>

    <div class="slot-machine">
        <div class="slot" id="slot-container-1"><div class="slot-inner">?</div></div>
        <div class="slot" id="slot-container-2"><div class="slot-inner">?</div></div>
        <div class="slot" id="slot-container-3"><div class="slot-inner">?</div></div>
    </div>

    <button class="draw-button" id="draw-button" disabled>Draw Winner</button>

    <script>
        // --- Global Variables (will be set by extractRaffleData) ---
        let raffleEntries = [];
        let globalRawData = [];
        let globalColumns = [];

        // --- Get DOM elements ---
        const slots = [
            document.getElementById('slot-container-1'),
            document.getElementById('slot-container-2'),
            document.getElementById('slot-container-3')
        ];
        const drawButton = document.getElementById('draw-button');
        const winnerMessage = document.getElementById('winner-message');

        const maxDrawDuration = 3000;
        const slotInterval = 100;

        // --- Core Data Processing Function ---
        function extractRaffleData(dataConfig) {
            // dataConfig is the object passed to new gridjs.Grid()
            const columns = dataConfig.columns;
            const rawData = dataConfig.data;
            let entries = [];
            
            if (!columns || !rawData) {
                console.error("Data structure not found in gridjs configuration.");
                return entries;
            }

            const accountNameIndex = columns.indexOf("Account Name");
            const attend30DIndex = columns.indexOf("30-Day Attend");
            const signedUp30DIndex = columns.indexOf("30D-Signed-Up");

            rawData.forEach(row => {
                const accountName = row[accountNameIndex];
                const attend = parseInt(row[attend30DIndex]);
                const signedUp = parseInt(row[signedUp30DIndex]);
                let entryCount = 0;

                // Logic: entries = min(attend, signedUp) IF both > 0, otherwise 0
                if (attend > 0 && signedUp > 0) {
                    entryCount = Math.min(attend, signedUp);
                }

                // Add the account name to the entries array 'entryCount' number of times
                for (let i = 0; i < entryCount; i++) {
                    entries.push(accountName);
                }
            });

            return entries;
        }

        // --- Slot Machine Logic (Remains the same) ---
        function pickWinner() {
            if (raffleEntries.length === 0) {
                winnerMessage.textContent = "No valid entries for the raffle!";
                return null;
            }
            const randomIndex = Math.floor(Math.random() * raffleEntries.length);
            return raffleEntries[randomIndex];
        }

        function rollSlot(slotElement, finalValue, duration, delay) {
            return new Promise(resolve => {
                let startTime;
                const slotInner = slotElement.querySelector('.slot-inner');
                
                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const elapsed = timestamp - startTime;

                    if (elapsed < duration) {
                        if ((elapsed % slotInterval) < 16) {
                            const randomIndex = Math.floor(Math.random() * raffleEntries.length);
                            const currentValue = raffleEntries[randomIndex] || "?";
                            slotInner.textContent = currentValue;
                        }
                        
                        requestAnimationFrame(step);
                    } else {
                        slotInner.textContent = finalValue;
                        resolve();
                    }
                };

                setTimeout(() => {
                    requestAnimationFrame(step);
                }, delay);
            });
        }

        async function startRaffleDraw() {
            if (drawButton.disabled) return;
            
            drawButton.disabled = true;
            winnerMessage.textContent = "Drawing in progress...";

            const winner = pickWinner();
            if (!winner) {
                drawButton.disabled = false;
                return;
            }

            slots.forEach(slot => {
                slot.querySelector('.slot-inner').textContent = '?';
            });

            await Promise.all([
                rollSlot(slots[0], winner, maxDrawDuration, 0),
                rollSlot(slots[1], winner, maxDrawDuration + 500, 200),
                rollSlot(slots[2], winner, maxDrawDuration + 1000, 400)
            ]);
            
            winnerMessage.textContent = `üéâ Congratulations to the winner: ${winner}! üéâ`;
            drawButton.disabled = false;
        }

        // --- Global Overrides for Data Loading ---
        // Since index.js runs the gridjs constructor globally, we hijack it 
        // to capture the data configuration before gridjs uses it.
        const originalGrid = window.gridjs.Grid;
        
        window.gridjs.Grid = function(config) {
            // 2. Capture the data and columns from the first grid configuration
            if (config.columns && config.data && config.columns.includes("Account Name")) {
                raffleEntries = extractRaffleData(config);

                // 3. Initialize the UI after processing data
                if (raffleEntries.length > 0) {
                    winnerMessage.textContent = `Total Raffle Entries: ${raffleEntries.length}. Click "Draw Winner" to begin!`;
                    drawButton.disabled = false;
                } else {
                    winnerMessage.textContent = "No accounts have qualified entries (30D Attend and 30D Signed-Up must be > 0)!";
                    drawButton.disabled = true;
                }
                
                // Set the event listener once the button is ready
                drawButton.addEventListener('click', startRaffleDraw);
            }

            // 4. Run the original gridjs constructor as intended for the table rendering
            return new originalGrid(config);
        };
        
        // --- Final Check (If index.js runs before this script, the gridjs.Grid override will capture the data) ---
        // If your environment requires a specific order: 
        // 1. Load the gridjs library.
        // 2. Define the window.gridjs.Grid override (this script).
        // 3. Load src/index.js.

    </script>
</body>
</html>