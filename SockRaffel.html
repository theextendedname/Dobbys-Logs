<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCK Attendance Raffle Picker</title>
    
    <!-- 1. Custom Definition to Capture Data -->
    <script>
        // Global object to store the data captured from index.js
        window.raffleDataConfig = {};

        // Define a minimal placeholder for 'gridjs' and its 'Grid' constructor.
        // This prevents the "gridjs is not defined" error without needing the library.
        window.gridjs = {
            Grid: function(config) {
                // *** FIX APPLIED HERE: Only capture data if raffleDataConfig.columns is currently undefined.
                // This ensures we only use the configuration from the FIRST call to new gridjs.Grid() ***
                if (!window.raffleDataConfig.columns && config && config.columns && config.data) {
                    window.raffleDataConfig.columns = config.columns;
                    window.raffleDataConfig.data = config.data;
                }
                // Return a dummy object for the render function
                return {
                    render: function() {}
                };
            }
        };
    </script>

    <!-- 2. Load External Data Script -->
    <!-- This runs immediately after the definition above and populates window.raffleDataConfig -->
    <script src="src/index.js"></script>

    <!-- 3. Styles from the previous stylesheet -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark mode background */
            color: #e2e8f0; /* Light text for dark background */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .kpi-card {
            background-color: #F29F05; /* Original KPI card color */
            color: white;
        }
        /* Custom styles for the slot machine and button */
        .slot-machine {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 50px;
        }
        .slot {
            background-color: #4a5568; 
            border: 4px solid #F29F05;
            border-radius: 8px;
            margin: 0 10px;
            width: 300px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }
        .slot-inner {
            width: 100%;
            text-align: center;
            position: absolute;
            transition: transform 0.1s ease-out;
        }
        .draw-button {
            display: block;
            width: 300px;
            margin: 40px auto 20px auto;
            padding: 15px 30px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            background-color: #00A6A6; /* Accent color */
            color: white;
            border: none;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }
        .draw-button:hover {
            background-color: #007a7a;
        }
        .draw-button:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
        }
        .winner-display {
            text-align: center;
            margin-top: 30px;
            font-size: 1.5rem;
            color: #F29F05;
            min-height: 40px;
        }
    </style>
</head>
<body>

    <h1 style="text-align: center; margin-top: 50px;">üçÄ SOCK Attendance Raffle Picker üçÄ</h1>

    <div class="winner-display" id="winner-message">Processing data from last 30 days...</div>

    <div class="slot-machine">
        <div class="slot" id="slot-container-1"><div class="slot-inner">?</div></div>
        <div class="slot" id="slot-container-2"><div class="slot-inner">?</div></div>
        <div class="slot" id="slot-container-3"><div class="slot-inner">?</div></div>
    </div>

    <button class="draw-button" id="draw-button" disabled>Draw Winner</button>

    <script>
        // --- Global Variables ---
        let raffleEntries = [];
        // Required names, stripped of spaces for aggressive comparison
        const requiredColumnsAgnostic = ["accountname", "30-dayattend", "30d-signed-up"]; 

        // --- Get DOM elements (omitted) ---
        const slots = [
            document.getElementById('slot-container-1'),
            document.getElementById('slot-container-2'),
            document.getElementById('slot-container-3')
        ];
        const drawButton = document.getElementById('draw-button');
        const winnerMessage = document.getElementById('winner-message');

        const maxDrawDuration = 3000;
        const slotInterval = 100;

        /**
         * Cleans a string by converting to lowercase and removing all whitespace globally.
         */
        function cleanString(str) {
            return String(str).toLowerCase().replace(/\s/g, '').trim();
        }
        /**
         * Performs a Fisher-Yates shuffle on the array in-place.
         * @param {Array} array 
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        // --- Core Data Processing Function ---
        function initializeRaffleData() {
            const dataConfig = window.raffleDataConfig;
            const columns = dataConfig.columns;
            const rawData = dataConfig.data;
            let entries = [];
            
            if (!columns || !rawData) {
                winnerMessage.textContent = "Error: Could not extract columns and data from index.js (check if the first gridjs.Grid call contains both).";
                return;
            }
            
            // Step 1: Normalize all file columns aggressively
            const normalizedFileColumns = columns.map(cleanString);

            // Step 2: Find indices using the normalized array
            const accountNameIndex = normalizedFileColumns.indexOf(requiredColumnsAgnostic[0]);
            const attend30DIndex = normalizedFileColumns.indexOf(requiredColumnsAgnostic[1]);
            const signedUp30DIndex = normalizedFileColumns.indexOf(requiredColumnsAgnostic[2]);

            // Step 3: Verify success
            if (accountNameIndex === -1 || attend30DIndex === -1 || signedUp30DIndex === -1) {
                winnerMessage.textContent = `Error: Required columns ('Account Name', '30-Day Attend', '30D-Signed-Up') not found in the FIRST grid configuration.`;
                return;
            }

            // Step 4: Calculate entries
            rawData.forEach(row => {
                const accountName = row[accountNameIndex];
                // Ensure values are parsed as integers, defaulting to 0
                const attend = parseInt(row[attend30DIndex]) || 0;
                const signedUp = parseInt(row[signedUp30DIndex]) || 0;
                let entryCount = 0;

                // Raffle Logic: entries = min(attend, signedUp) IF both > 0, otherwise 0
                if (attend > 0 && signedUp > 0) {
                    entryCount = Math.min(attend, signedUp);
                }

                // Add the account name to the entries array 'entryCount' number of times
                for (let i = 0; i < entryCount; i++) {
                    entries.push(accountName);
                }
            });
            //Step4.5 Randomize the entries array
            shuffleArray(entries);
        
            // Step 5: Initialize UI
            raffleEntries = entries;
            if (raffleEntries.length > 0) {
                winnerMessage.textContent = `Total Raffle Entries: ${raffleEntries.length} based on the last 30 days. Click "Draw Winner" to begin!`;
                drawButton.disabled = false;
                drawButton.addEventListener('click', startRaffleDraw);
            } else {
                winnerMessage.textContent = "No accounts have qualified entries (30D Attend and 30D Signed-Up must be > 0)!";
                drawButton.disabled = true;
            }
        }

        // --- Slot Machine Logic ---
        function pickWinner() {
            if (raffleEntries.length === 0) return null;
            const randomIndex = Math.floor(Math.random() * raffleEntries.length);
            return raffleEntries[randomIndex];
        }

        function rollSlot(slotElement, finalValue, duration, delay) {
            return new Promise(resolve => {
                let startTime;
                const slotInner = slotElement.querySelector('.slot-inner');
                
                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const elapsed = timestamp - startTime;

                    if (elapsed < duration) {
                        if ((elapsed % slotInterval) < 16) {
                            const randomIndex = Math.floor(Math.random() * raffleEntries.length);
                            const currentValue = raffleEntries[randomIndex] || "?";
                            slotInner.textContent = currentValue;
                        }
                        requestAnimationFrame(step);
                    } else {
                        slotInner.textContent = finalValue;
                        resolve();
                    }
                };

                setTimeout(() => {
                    requestAnimationFrame(step);
                }, delay);
            });
        }

        async function startRaffleDraw() {
            if (drawButton.disabled) return;
            
            drawButton.disabled = true;
            winnerMessage.textContent = "Drawing in progress...";

            const winner = pickWinner();
            if (!winner) {
                drawButton.disabled = false;
                return;
            }

            slots.forEach(slot => {
                slot.querySelector('.slot-inner').textContent = '?';
            });

            await Promise.all([
                rollSlot(slots[0], winner, maxDrawDuration, 0),
                rollSlot(slots[1], winner, maxDrawDuration + 500, 200),
                rollSlot(slots[2], winner, maxDrawDuration + 1000, 400)
            ]);
            
            winnerMessage.textContent = `üéâ Congratulations to the winner: ${winner}! üéâ`;
            drawButton.disabled = false;
        }

        // --- Execute Data Processing after all scripts and the DOM are loaded ---
        document.addEventListener('DOMContentLoaded', initializeRaffleData);

    </script>
</body>
</html>